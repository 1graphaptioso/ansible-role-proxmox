---
- hosts: localhost
  connection: local
  roles:
    - { name: lae.travis-lxc }
  tasks:
    - name: Create SSL directory for storing secrets
      file:
        dest: tests/ssl
        state: directory
    - name: Create Root CA private key
      shell: openssl genrsa -out tests/ssl/test-ca.key 2048
    - name: Create Root CA certificate
      shell: "openssl req -x509 -new -nodes -key tests/ssl/test-ca.key -sha256 -days 1 -subj '/C=JP/ST=Kyoto Prefecture/L=Kyoto/O=Idol Activities/OU=test/CN=test-cluster' -out tests/ssl/test-ca.pem"
    - name: Install Root CA certificate
      copy:
        src: ssl/test-ca.pem
        dest: /usr/local/share/ca-certificates/test-ca.pem
    - name: Update CA certificate store
      shell: update-ca-certificates
  vars:
    host_quantity: 3

# Run the following within the containers in the inventory
- hosts: all
  tasks:
    - name: Create FUSE device within containers
      command: "mknod -m 666 /dev/fuse c 10 229"
      args:
        creates: /dev/fuse
    - name: Create host SSL private key
      shell: "openssl genrsa -out tests/ssl/{{ inventory_hostname }}.key 2048"
    - name: Create host SSL certificate signing request
      shell: "openssl req -new -key tests/ssl/{{ inventory_hostname }}.key -subj '/C=JP/ST=Kyoto Prefecture/L=Kyoto/O=Idol Activities/OU=test/CN={{ inventory_hostname }}' -out tests/ssl/{{ inventory_hostname }}.csr"
    - name: Create host SSL certificate
      shell: "openssl x509 -req -in tests/ssl/{{ inventory_hostname }}.csr -CA tests/ssl/test-ca.pem -CAkey tests/ssl/test-ca.key -days 1 -CAcreateserial -sha256 -out tests/ssl/{{ inventory_hostname }}.pem"
